<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>微信风格聊天室</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #f7f7f7;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .chat-container {
      width: 90%;
      max-width: 800px;
      height: 90vh;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: #f7f7f7;
      color: #000;
      padding: 16px 20px;
      text-align: center;
      font-size: 17px;
      font-weight: 500;
      border-bottom: 1px solid #e7e7e7;
      position: relative;
    }

    .online-count {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #888;
    }

    #messages {
      flex: 1;
      background: #f7f7f7;
      overflow-y: auto;
      padding: 0;
    }

    #messages::-webkit-scrollbar {
      width: 4px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 2px;
    }

    .message-group {
      padding: 0px 16px;
      display: flex;
      flex-direction: column;
      animation: messageIn 0.2s ease-out;
    }

    @keyframes messageIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-row {
      display: flex;
      margin-bottom: 8px;
      align-items: flex-start;
    }

    .message-row.own {
      flex-direction: row-reverse;
    }

    .message-row.system {
      justify-content: center;
      margin: 8px 0;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 4px;
      background: linear-gradient(135deg, #07c160, #00d4aa);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      margin: 0 8px 0 0;
      flex-shrink: 0;
    }

    .message-content {
      max-width: 60%;
      display: flex;
      flex-direction: column;
    }

    .message-row.own .message-content {
      align-items: flex-end;
    }

    .message-bubble {
      position: relative;
      padding: 0px 10px;
      border-radius: 8px;
      max-width: 100%;
      word-wrap: break-word;
      font-size: 16px;
      min-width: 80px;
      margin-left: 8px;
      margin-right: 0;
    }

    .bubble-username {
      font-size: 11px;
      color: #888;
      margin-bottom: 2px;
      font-weight: 500;
      text-align: left;
      line-height: 1.2;
    }

    .bubble-content {
      font-size: 15px;
      line-height: 1.3;
      margin-bottom: 2px;
    }

    .bubble-time {
      font-size: 10px;
      color: #b2b2b2;
      text-align: right;
      margin-top: 1px;
      line-height: 1.2;
    }

    /* 其他人的消息气泡 */
    .message-bubble.other {
      background: white;
      color: #000;
      border-top-left-radius: 2px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* 自己的消息气泡 */
    .message-bubble.own {
      background: #95ec69;
      color: #000;
      border-top-right-radius: 2px;
    }

    .message-bubble.own .bubble-username {
      color: rgba(0, 0, 0, 0.6);
      text-align: right;
    }

    .message-bubble.own .bubble-time {
      color: rgba(0, 0, 0, 0.5);
    }

    /* 系统消息 */
    .message-bubble.system {
      background: rgba(0, 0, 0, 0.05);
      color: #888;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
      max-width: none;
    }

    /* 消息气泡小尖角 */
    .message-bubble.other::before {
      content: '';
      position: absolute;
      top: 0;
      left: -6px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 6px 8px 0;
      border-color: transparent white transparent transparent;
    }

    .message-bubble.own::before {
      content: '';
      position: absolute;
      top: 0;
      right: -6px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 0 8px 6px;
      border-color: transparent transparent transparent #95ec69;
    }

    .time-divider {
      text-align: center;
      margin: 16px 0 8px;
      font-size: 12px;
      color: #b2b2b2;
    }

    .input-container {
      background: #f7f7f7;
      border-top: 1px solid #e7e7e7;
      padding: 8px;
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 6px;
      border: 1px solid #d9d9d9;
      overflow: hidden;
    }

    #input {
      flex: 1;
      border: none;
      padding: 10px 12px;
      font-size: 16px;
      outline: none;
      background: transparent;
      min-height: 20px;
      max-height: 100px;
      resize: none;
      line-height: 1.4;
    }

    .send-button {
      background: #07c160;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
      margin: 2px;
      border-radius: 4px;
    }

    .send-button:hover:not(:disabled) {
      background: #06ad56;
    }

    .send-button:disabled {
      background: #d9d9d9;
      cursor: not-allowed;
    }

    .username-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      text-align: center;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-content h2 {
      margin-bottom: 20px;
      color: #000;
      font-size: 18px;
      font-weight: 500;
    }

    .modal-content input {
      width: 100%;
      padding: 12px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 16px;
      outline: none;
    }

    .modal-content input:focus {
      border-color: #07c160;
    }

    .modal-button {
      background: #07c160;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }

    .modal-button:hover {
      background: #06ad56;
    }

    @media (max-width: 768px) {
      .chat-container {
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }
      
      .message-content {
        max-width: 70%;
      }
      
      .avatar {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .input-container {
        padding: 6px;
      }
    }
  </style>
</head>
<body>
  <!-- 用户名输入模态框 -->
  <div id="usernameModal" class="username-modal" style="display: none;">
    <div class="modal-content">
      <h2>加入聊天室</h2>
      <input id="usernameInput" type="text" placeholder="请输入昵称" maxlength="20">
      <button class="modal-button" onclick="setUsername">开始聊天</button>
    </div>
  </div>

  <div class="chat-container">
    <div class="chat-header">
      聊天室
      <div class="online-count">
        <span id="onlineCount">1</span> 人在线
      </div>
    </div>
    
    <div id="messages"></div>
    
    <div class="input-container">
      <div class="input-wrapper">
        <textarea id="input" placeholder="输入消息..." disabled rows="1"></textarea>
        <button type="submit" class="send-button" disabled>发送</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
  <script>
    // 检查用户是否已登录
    window.onload = function() {
      const savedUser = localStorage.getItem('chatUser');
      if (!savedUser) {
        window.location.href = '/login';
      }
    };
    
    const socket = io({
      transports: ['websocket', 'polling'],
      upgrade: true,
      rememberUpgrade: false,
      forceNew: true
    });
    const input = document.getElementById('input');
    const box = document.getElementById('messages');
    const usernameModal = document.getElementById('usernameModal');
    const usernameInput = document.getElementById('usernameInput');
    const sendButton = document.querySelector('.send-button');
    
    let currentUser = '';
    let lastMessageTime = null;

    function setUsername() {
      // 从localStorage获取登录用户信息
      const savedUser = localStorage.getItem('chatUser');
      if (savedUser) {
        const user = JSON.parse(savedUser);
        currentUser = user.username;
        usernameModal.style.display = 'none';
        input.disabled = false;
        sendButton.disabled = false;
        input.focus();
        appendMessage('系统', `${currentUser} 加入了聊天室`, 'system');
        return;
      }
      
      // 如果没有登录用户信息，保持原有逻辑
      const username = usernameInput.value.trim();
      if (username === '') {
        alert('请输入昵称');
        return;
      }
      currentUser = username;
      usernameModal.style.display = 'none';
      input.disabled = false;
      sendButton.disabled = false;
      input.focus();
      appendMessage('系统', `${currentUser} 加入了聊天室`, 'system');
    }

    usernameInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') setUsername();
    });

    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      sendButton.disabled = this.value.trim() === '';
    });

    function sendMessage() {
      const message = input.value.trim();
      if (message === '' || !currentUser) return;
      socket.emit('chat', {name: currentUser, msg: message});
      input.value = '';
      input.style.height = 'auto';
      sendButton.disabled = true;
    }

    sendButton.addEventListener('click', sendMessage);
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    socket.on('history', list => {
      list.forEach(m => {
        const messageTime = m.timestamp ? new Date(m.timestamp) : null;
        appendMessage(m.name, m.msg, m.name === currentUser ? 'own' : 'other', messageTime);
      });
    });

    socket.on('chat', data => {
      const messageTime = data.timestamp ? new Date(data.timestamp) : null;
      appendMessage(data.name, data.msg, data.name === currentUser ? 'own' : 'other', messageTime);
    });

    function getAvatarChar(username) {
      if (!username) return '?';
      if (/[\u4e00-\u9fa5]/.test(username)) {
        return username.charAt(0);
      }
      return username.charAt(0).toUpperCase();
    }

    function getAvatarColor(username) {
      const colors = ['#07c160', '#576b95', '#ed6a0c', '#c9394a',
        '#74a2ff', '#f4a100', '#00d4aa', '#ff6b6b',
        '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b'
      ];
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }

    function shouldShowTime(currentTime) {
      if (!lastMessageTime) return true;
      const diff = currentTime - lastMessageTime;
      return diff > 5 * 60 * 1000;
    }

    function appendMessage(name, message, type, messageTime = null) {
      // 使用传入的时间，如果没有则使用当前时间
      const now = messageTime || new Date();
      const showTime = shouldShowTime(now);
      const isOwnMessage = name === currentUser; // 判断是否是当前用户的消息
      const messageType = isOwnMessage ? 'own' : type; // 统一消息类型
      const showAvatar = messageType !== 'system' && messageType !== 'own'; // 不显示自己的头像

      if (showTime && messageType !== 'system') {
        const timeDivider = document.createElement('div');
        timeDivider.className = 'time-divider';
        timeDivider.textContent = formatTime(now);
        box.appendChild(timeDivider);
        lastMessageTime = now;
      }

      const messageGroup = document.createElement('div');
      messageGroup.className = 'message-group';

      if (messageType === 'system') {
        const systemBubble = document.createElement('div');
        systemBubble.className = 'message-row system';
        systemBubble.innerHTML = `<div class="message-bubble system">${message}</div>`;
        messageGroup.appendChild(systemBubble);
      } else {
        const messageRow = document.createElement('div');
        messageRow.className = `message-row ${messageType}`;

        let avatarHtml = '';
        if (showAvatar) {
          const avatarChar = getAvatarChar(name);
          const avatarColor = getAvatarColor(name);
          avatarHtml = `<div class="avatar" style="background: ${avatarColor}">${avatarChar}</div>`;
        }

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        // 使用消息的实际时间而不是当前时间
        const timeString = now.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        
        const displayName = messageType === 'own' ? '我' : name;
        const bubbleContent = `
          <div class="message-bubble ${messageType}">
            ${messageType === 'other' ? `<div class="bubble-username">${displayName}</div>` : `<div class="bubble-username">${displayName}</div>`}
            <div class="bubble-content">${escapeHtml(message)}</div>
            <div class="bubble-time">${timeString}</div>
          </div>
        `;
        messageContent.innerHTML = bubbleContent;

        if (messageType === 'other') {
          messageRow.innerHTML = avatarHtml;
          messageRow.appendChild(messageContent);
        } else {
          messageRow.appendChild(messageContent);
          // 自己发送的消息不显示头像
        }

        messageGroup.appendChild(messageRow);
      }

      box.appendChild(messageGroup);
      setTimeout(() => {
        box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
      }, 50);
    }

    function formatTime(date) {
      return date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }

    // 页面加载完成后自动设置用户名
    window.addEventListener('load', () => {
      setUsername();
    });
    
    socket.on('connect', () => console.log('已连接到服务器'));
    socket.on('disconnect', () => appendMessage('系统', '连接已断开，正在重新连接...', 'system'));
    socket.on('reconnect', () => appendMessage('系统', '重新连接成功', 'system'));
  </script>
</body>
</html>